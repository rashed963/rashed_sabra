---
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { formatDate, slugify } from "../../utils/content";

export async function getStaticPaths() {
  const entries = await getCollection("blog", ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const { title, description, publishDate, series, part, heroImage, category } =
  entry.data;
const heroImageModules = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/blog/images/*.{avif,gif,jpg,jpeg,png,webp,svg}"
);
const heroImagePath =
  typeof heroImage === "string"
    ? `/src/content/blog/${heroImage.replace(/^\.\//, "")}`
    : null;
const heroImageAsset =
  typeof heroImage === "string"
    ? (await heroImageModules[heroImagePath ?? ""]?.())?.default ?? null
    : heroImage;

const allEntries = await getCollection("blog", ({ data }) => !data.draft);
const seriesEntries = series
  ? allEntries
      .filter((post) => post.data.series === series)
      .sort((a, b) => {
        const partA = a.data.part ?? 0;
        const partB = b.data.part ?? 0;
        if (partA !== partB) {
          return partA - partB;
        }
        return (
          new Date(a.data.publishDate).valueOf() -
          new Date(b.data.publishDate).valueOf()
        );
      })
  : [];
const currentIndex = seriesEntries.findIndex((post) => post.slug === entry.slug);
const previousEntry =
  currentIndex > 0 ? seriesEntries[currentIndex - 1] : null;
const nextEntry =
  currentIndex >= 0 && currentIndex < seriesEntries.length - 1
    ? seriesEntries[currentIndex + 1]
    : null;
---

<Layout>
  <main class="container">
    <article class="card">
      <header class="post-header">
        {(category || series) && (
          <div class="post-meta">
            {category && (
              <a
                href={`/blog/categories/${slugify(category)}`}
                class="pill pill-link"
              >
                {category}
              </a>
            )}
            {series && (
              <a
                href={`/blog/series/${slugify(series)}`}
                class="pill pill-link pill-muted"
              >
                {series}
                {part != null ? ` · الجزء ${part}` : ""}
              </a>
            )}
          </div>
        )}
        <h1 class="hero-title">{title}</h1>
        <time datetime={publishDate.toISOString()} class="meta">
          {formatDate(publishDate)}
        </time>
        {description && <p class="post-description">{description}</p>}
        {heroImageAsset && (
          <Image
            src={heroImageAsset}
            alt={title}
            class="hero-image"
            loading="eager"
          />
        )}
      </header>
      <div class="prose">
        <Content />
      </div>
      {series && seriesEntries.length > 1 && (
        <footer class="series-nav">
          <div class="section-header">
            <h2 class="section-title">سلسلة {series}</h2>
            <a href={`/blog/series/${slugify(series)}`} class="button-link">
              عرض جميع الأجزاء
            </a>
          </div>
          <ul class="series-steps">
            {seriesEntries.map((post) => (
              <li class={post.slug === entry.slug ? "series-step active" : "series-step"}>
                <a href={`/blog/${post.slug}`} class="series-step-link">
                  <span class="series-step-title">{post.data.title}</span>
                  {post.data.part != null && (
                    <span class="meta">الجزء {post.data.part}</span>
                  )}
                </a>
              </li>
            ))}
          </ul>
          <div class="series-pagination">
            {previousEntry ? (
              <a href={`/blog/${previousEntry.slug}`} class="button-link">
                ← المقال السابق
              </a>
            ) : (
              <span class="muted">لا يوجد مقال سابق</span>
            )}
            {nextEntry ? (
              <a href={`/blog/${nextEntry.slug}`} class="button-link">
                المقال التالي →
              </a>
            ) : (
              <span class="muted">لا يوجد مقال لاحق</span>
            )}
          </div>
        </footer>
      )}
    </article>
  </main>
</Layout>
